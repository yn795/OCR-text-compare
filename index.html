<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Precision OCR for Small Text</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            text-align: center;
        }
        .container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
        }
        .image-container {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
        }
        .ocr-output {
            width: 100%;
            height: 200px;
            font-size: 16px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        button {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>High Precision OCR for Small Text</h1>
    <div class="container">
        <div class="image-container">
            <label for="imageInput">Upload images for OCR:</label>
            <input type="file" id="imageInput" multiple accept="image/*">
            <button onclick="performOCR()">Scan and Process OCR</button>
        </div>
        <textarea id="ocrOutput" class="ocr-output" placeholder="OCR results will appear here..."></textarea>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js"></script>
    <script>
        async function preprocessImage(imageFile) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            return new Promise((resolve, reject) => {
                img.onload = () => {
                    canvas.width = img.width * 6; // 解像度を6倍に拡大
                    canvas.height = img.height * 6;
                    ctx.scale(6, 6);
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    // コントラスト強化とノイズ除去
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        const avg = 0.299 * r + 0.587 * g + 0.114 * b; // 輝度
                        const adjusted = avg > 150 ? 255 : 0; // 明暗を強調
                        data[i] = adjusted;
                        data[i + 1] = adjusted;
                        data[i + 2] = adjusted;
                    }
                    ctx.putImageData(imageData, 0, 0);

                    resolve(canvas.toDataURL());
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(imageFile);
            });
        }

        async function performOCR() {
            const files = document.getElementById('imageInput').files;
            const ocrOutput = document.getElementById('ocrOutput');
            ocrOutput.value = '';

            for (const file of files) {
                const preprocessedImage = await preprocessImage(file);
                try {
                    const { data: { text } } = await Tesseract.recognize(preprocessedImage, 'jpn', {
                        logger: info => console.log(info), // ログを確認するため
                        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789ぁ-んァ-ン一-龥、。・「」' // 日本語用の文字セット
                    });
                    ocrOutput.value += text + '\n\n';
                } catch (error) {
                    console.error(error);
                }
            }
        }
    </script>
</body>
</html>
